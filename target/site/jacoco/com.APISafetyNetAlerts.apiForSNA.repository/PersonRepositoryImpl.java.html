<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>PersonRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">api</a> &gt; <a href="index.source.html" class="el_package">com.APISafetyNetAlerts.apiForSNA.repository</a> &gt; <span class="el_source">PersonRepositoryImpl.java</span></div><h1>PersonRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.APISafetyNetAlerts.apiForSNA.repository;

import java.io.File;
import java.io.IOException;
import java.util.ArrayList;
import java.util.List;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.stereotype.Repository;

import com.APISafetyNetAlerts.apiForSNA.model.ListPerson;
import com.APISafetyNetAlerts.apiForSNA.model.Person;
import com.APISafetyNetAlerts.apiForSNA.restModel.ListPersonAdaptative;
import com.APISafetyNetAlerts.apiForSNA.restModel.PersonAdaptative;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectWriter;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;

/**
 * 
 * Interaction with the object persons in the data.json file
 *
 */

@Repository
<span class="fc" id="L30">public class PersonRepositoryImpl implements PersonRepository {</span>

    // ObjectMapper to be able to deserialize JSON
<span class="fc" id="L33">    private ObjectMapper mapper = new ObjectMapper();</span>
    // List persons to load only one time
    private ListPerson loadListPersons;
    // List person to send
<span class="fc" id="L37">    private ListPerson listPersonsToSend = new ListPerson();</span>
    // List persons adaptative to load only one time
    private ListPersonAdaptative loadListPersonsAdaptative;
    // List persons adaptative to send
<span class="fc" id="L41">    private ListPersonAdaptative listPersonsAdaptativeToSend = new ListPersonAdaptative();</span>
    // List person to sort and to set
    private List&lt;Person&gt; listPersonsSorted;
    // List persons adaptative to sort and to set
    private List&lt;PersonAdaptative&gt; listPersonsAdaptativeSorted;
    // Logger
<span class="fc" id="L47">    private static Logger logger = LogManager.getLogger(PersonRepositoryImpl.class);</span>
    // File to read
<span class="fc" id="L49">    File file = new File(&quot;D:\\workspace\\git\\apiForSNA\\src\\main\\resources\\data.json&quot;);</span>

    /**
     * Read JSON file if it has not been read already and load it
     * 
     * @return list of persons from file
     */
    @Override
    public ListPerson loadPersons(boolean force) {
<span class="fc" id="L58">	mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc bfc" id="L59" title="All 2 branches covered.">	if (loadListPersons == null) {</span>
	    try {
<span class="fc" id="L61">		loadListPersons = mapper.readValue(file, ListPerson.class);</span>
<span class="fc" id="L62">		logger.info(&quot;Le fichier est lu pour récupérer les personnes !&quot;);</span>
<span class="fc" id="L63">		return loadListPersons;</span>
<span class="nc" id="L64">	    } catch (IOException e) {</span>
<span class="nc" id="L65">		logger.error(&quot;Fichier introuvable&quot;);</span>
	    }
	}
<span class="fc" id="L68">	return loadListPersons;</span>
    }

    /**
     * Read JSON file if it has not been read already
     * 
     * @return list of person adaptative from file
     */
    @Override
    public ListPersonAdaptative loadPersonsAdaptative(boolean force) {
<span class="fc" id="L78">	mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc bfc" id="L79" title="All 2 branches covered.">	if (loadListPersonsAdaptative == null) {</span>
	    try {
<span class="fc" id="L81">		loadListPersonsAdaptative = mapper.readValue(file, ListPersonAdaptative.class);</span>
<span class="fc" id="L82">		logger.info(&quot;Le fichier est lu pour récupérer les personnes dont on veut ajouter des informations!&quot;);</span>
<span class="fc" id="L83">		return loadListPersonsAdaptative;</span>
<span class="nc" id="L84">	    } catch (IOException e) {</span>
<span class="nc" id="L85">		logger.error(&quot;Fichier introuvable&quot;);</span>
	    }
	}
<span class="fc" id="L88">	return loadListPersonsAdaptative;</span>
    }

    /**
     * Get all persons
     * 
     * @return a list of all persons
     */
    @Override
    public ListPerson findAllPersons() {
	// Read the file and fill the list if it's not
<span class="fc" id="L99">	loadListPersons = loadPersons(false);</span>
<span class="fc" id="L100">	return loadListPersons;</span>
    }

    /**
     * Get all persons
     * 
     * @return a list of all persons
     */
    @Override
    public ListPersonAdaptative findAllPersonAdaptative() {
	// Read the file and fill the list if it's not
<span class="fc" id="L111">	loadListPersonsAdaptative = loadPersonsAdaptative(false);</span>
<span class="fc" id="L112">	return loadListPersonsAdaptative;</span>
    }

    /**
     * Get all persons who live in the city
     * 
     * @param city city where lives the person
     * @return a list of persons who lives in the city
     */
    @Override
    public ListPerson findPersonsByCity(String city) {
	// Read the file and fill the list if it's not
<span class="fc" id="L124">	loadListPersons = loadPersons(false);</span>
<span class="fc" id="L125">	listPersonsSorted = new ArrayList&lt;Person&gt;();</span>
<span class="fc bfc" id="L126" title="All 2 branches covered.">	for (Person p : loadListPersons.getListPersons()) {</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">	    if (p.getCity().equals(city)) {</span>
<span class="fc" id="L128">		listPersonsSorted.add(p);</span>
	    }
	}
<span class="fc" id="L131">	listPersonsToSend.setListPersons(listPersonsSorted);</span>
<span class="fc" id="L132">	return listPersonsToSend;</span>
    }

    /**
     * Get all persons who live at an address
     * 
     * @param address address of a person
     * @return a list of persons who live at an address
     */
    @Override
    public ListPersonAdaptative findPersonAdaptativeByAddress(String address) {
	// Read the file and fill the list if it's not
<span class="fc" id="L144">	loadListPersonsAdaptative = loadPersonsAdaptative(false);</span>
<span class="fc" id="L145">	listPersonsAdaptativeSorted = new ArrayList&lt;PersonAdaptative&gt;();</span>
<span class="fc bfc" id="L146" title="All 2 branches covered.">	for (PersonAdaptative p : loadListPersonsAdaptative.getListPersons()) {</span>
<span class="fc bfc" id="L147" title="All 2 branches covered.">	    if (p.getAddress().equals(address)) {</span>
<span class="fc" id="L148">		listPersonsAdaptativeSorted.add(p);</span>
	    }
	}
<span class="fc" id="L151">	listPersonsAdaptativeToSend.setListPersons(listPersonsAdaptativeSorted);</span>
<span class="fc" id="L152">	return listPersonsAdaptativeToSend;</span>
    }

    /**
     * Get all persons with the last name
     * 
     * @param lastName last name of persons
     * @return a list of persons with the last name
     */
    @Override
    public ListPersonAdaptative findPersonsAdaptativeByLastName(String lastName) {
	// Read the file and fill the list if it's not
<span class="fc" id="L164">	loadListPersonsAdaptative = loadPersonsAdaptative(false);</span>
<span class="fc" id="L165">	listPersonsAdaptativeSorted = new ArrayList&lt;PersonAdaptative&gt;();</span>
<span class="fc bfc" id="L166" title="All 2 branches covered.">	for (PersonAdaptative p : loadListPersonsAdaptative.getListPersons()) {</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">	    if (p.getLastName().equals(lastName)) {</span>
<span class="fc" id="L168">		listPersonsAdaptativeSorted.add(p);</span>
	    }
	}
<span class="fc" id="L171">	listPersonsAdaptativeToSend.setListPersons(listPersonsAdaptativeSorted);</span>
<span class="fc" id="L172">	return listPersonsAdaptativeToSend;</span>
    }

    /**
     * Get all persons with last name AND first name
     * 
     * @param lastName  last name of a person
     * @param firstName first name of a person
     * @return a list of persons with last name AND first name
     */
    @Override
    public ListPersonAdaptative findPersonsAdaptativeByFirstNameAndLastName(String firstName, String lastName) {
	// Read the file and fill the list if it's not
<span class="fc" id="L185">	loadListPersonsAdaptative = loadPersonsAdaptative(false);</span>
<span class="fc" id="L186">	listPersonsAdaptativeSorted = new ArrayList&lt;PersonAdaptative&gt;();</span>
<span class="fc bfc" id="L187" title="All 2 branches covered.">	for (PersonAdaptative p : loadListPersonsAdaptative.getListPersons()) {</span>
<span class="fc bfc" id="L188" title="All 4 branches covered.">	    if (p.getLastName().equals(lastName) &amp;&amp; p.getFirstName().equals(firstName)) {</span>
<span class="fc" id="L189">		listPersonsAdaptativeSorted.add(p);</span>
	    }
	}
<span class="fc" id="L192">	listPersonsAdaptativeToSend.setListPersons(listPersonsAdaptativeSorted);</span>
<span class="fc" id="L193">	return listPersonsAdaptativeToSend;</span>
    }

    /**
     * Add new person to the JSON File
     * 
     * @param person person to add
     * @return created person
     */
    @Override
    public void savePerson(Person person) {
	// Person to add
<span class="fc" id="L205">	Person newPerson = new Person(person.getFirstName(), person.getLastName(), person.getAddress(),</span>
<span class="fc" id="L206">		person.getCity(), person.getZip(), person.getPhone(), person.getEmail());</span>
<span class="fc" id="L207">	logger.debug(&quot;La personne à ajouter : {}&quot;, person.toString());</span>
	try {
	    // if all fields are filled
<span class="fc bfc" id="L210" title="All 6 branches covered.">	    if (person.getFirstName() != null &amp;&amp; person.getLastName() != null &amp;&amp; person.getAddress() != null</span>
<span class="fc bfc" id="L211" title="All 6 branches covered.">		    &amp;&amp; person.getCity() != null &amp;&amp; person.getZip() &gt; 0 &amp;&amp; person.getPhone() != null</span>
<span class="fc bfc" id="L212" title="All 2 branches covered.">		    &amp;&amp; person.getEmail() != null) {</span>

		// Log the result if debug mode is enabled
<span class="fc bfc" id="L215" title="All 2 branches covered.">		if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L216">		    ObjectMapper objectMapper = new ObjectMapper();</span>
		    try {
<span class="fc" id="L218">			String json = objectMapper.writerWithDefaultPrettyPrinter().writeValueAsString(newPerson);</span>
<span class="fc" id="L219">			logger.debug(&quot;Personne à ajouter : {}&quot;, json);</span>
<span class="pc" id="L220">		    } catch (Exception e) {</span>
<span class="nc" id="L221">			logger.error(&quot;Mapping error&quot;);</span>
		    }
		}
		// Writer to write in Json
<span class="fc" id="L225">		ObjectWriter writer = mapper.writer();</span>
		// read json file
<span class="fc" id="L227">		JsonNode parsedJson = mapper.readTree(file);</span>
		// Get the array of persons
<span class="fc" id="L229">		ArrayNode personsArray = (ArrayNode) parsedJson.get(&quot;persons&quot;);</span>
		// add person to the array
<span class="fc" id="L231">		personsArray.add(mapper.convertValue(newPerson, JsonNode.class));</span>
		// write in the file
<span class="fc" id="L233">		writer.writeValue(file, parsedJson);</span>
<span class="fc" id="L234">		loadPersons(true);</span>
<span class="fc" id="L235">	    } else {</span>
<span class="fc" id="L236">		throw new IllegalArgumentException(&quot;Un des champs est incorrect !&quot;);</span>
	    }
<span class="nc" id="L238">	} catch (IOException e) {</span>
<span class="nc" id="L239">	    logger.error(&quot;file not found&quot;);</span>
<span class="fc" id="L240">	} catch (IllegalArgumentException e) {</span>
<span class="fc bfc" id="L241" title="All 2 branches covered.">	    if (person.getFirstName() == null)</span>
<span class="fc" id="L242">		logger.error(&quot;Le champ prénom ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L243" title="All 2 branches covered.">	    if (person.getLastName() == null)</span>
<span class="fc" id="L244">		logger.error(&quot;Le champ nom ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L245" title="All 2 branches covered.">	    if (person.getAddress() == null)</span>
<span class="fc" id="L246">		logger.error(&quot;Le champ addresse ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L247" title="All 2 branches covered.">	    if (person.getCity() == null)</span>
<span class="fc" id="L248">		logger.error(&quot;Le champ ville ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L249" title="All 2 branches covered.">	    if (person.getZip() &lt;= 0)</span>
<span class="fc" id="L250">		logger.error(&quot;Le champ code postal ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L251" title="All 2 branches covered.">	    if (person.getPhone() == null)</span>
<span class="fc" id="L252">		logger.error(&quot;Le champ numéro de téléphone ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L253" title="All 2 branches covered.">	    if (person.getEmail() == null)</span>
<span class="fc" id="L254">		logger.error(&quot;Le champ email ne doit pas être vide !&quot;);</span>
	}

<span class="fc" id="L257">    }</span>

    /**
     * Update person in the JSON File
     * 
     * @param person person to update
     * @return updated person
     */
    @Override
    public void updatePerson(Person person) {
	try {
	    // Verify if the update is done
<span class="fc" id="L269">	    boolean update = false;</span>
	    // JSON file
<span class="fc" id="L271">	    JsonNode parsedJson = mapper.readTree(file);</span>
	    // Array to read in JSON file
<span class="fc" id="L273">	    ArrayNode personsArray = (ArrayNode) parsedJson.get(&quot;persons&quot;);</span>
	    // Object to get
	    ObjectNode object;
	    // Browse the array
<span class="fc bfc" id="L277" title="All 2 branches covered.">	    for (int prsn = 0; prsn &lt; personsArray.size(); prsn++) {</span>
		// verify If the couple of First Name and Last Name is in the list
<span class="fc bfc" id="L279" title="All 2 branches covered.">		if (personsArray.get(prsn).get(&quot;firstName&quot;).toString().equals(&quot;\&quot;&quot; + person.getFirstName() + &quot;\&quot;&quot;)</span>
<span class="fc" id="L280">			&amp;&amp; personsArray.get(prsn).get(&quot;lastName&quot;).toString()</span>
<span class="fc bfc" id="L281" title="All 2 branches covered.">				.equals(&quot;\&quot;&quot; + person.getLastName() + &quot;\&quot;&quot;)) {</span>
<span class="fc" id="L282">		    object = (ObjectNode) personsArray.get(prsn);</span>
<span class="fc" id="L283">		    logger.debug(&quot;Personne à modifier : {}&quot;, object.toString());</span>
<span class="fc bfc" id="L284" title="All 2 branches covered.">		    if (person.getAddress() != null)</span>
<span class="fc" id="L285">			object.put(&quot;address&quot;, person.getAddress());</span>
<span class="fc bfc" id="L286" title="All 2 branches covered.">		    if (person.getCity() != null)</span>
<span class="fc" id="L287">			object.put(&quot;city&quot;, person.getCity());</span>
<span class="fc bfc" id="L288" title="All 2 branches covered.">		    if (person.getZip() &gt; 0)</span>
<span class="fc" id="L289">			object.put(&quot;zip&quot;, person.getZip());</span>
<span class="fc bfc" id="L290" title="All 2 branches covered.">		    if (person.getPhone() != null)</span>
<span class="fc" id="L291">			object.put(&quot;phone&quot;, person.getPhone());</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">		    if (person.getEmail() != null)</span>
<span class="fc" id="L293">			object.put(&quot;email&quot;, person.getEmail());</span>
<span class="fc" id="L294">		    mapper.writeValue(file, parsedJson);</span>
<span class="fc" id="L295">		    logger.debug(&quot;Personne qui a été modifiée : {}&quot;, object.toString());</span>
<span class="fc" id="L296">		    update = true;</span>
		}
	    }
<span class="fc bfc" id="L299" title="All 2 branches covered.">	    if (!update) {</span>
<span class="fc" id="L300">		throw new IllegalArgumentException(&quot;Il n'y a aucune personne avec ce nom et prénom dans la liste !&quot;);</span>
	    }
<span class="nc" id="L302">	} catch (IOException e) {</span>
<span class="nc" id="L303">	    logger.error(&quot;Le fichier n'a pas pu être lu&quot;);</span>
<span class="fc" id="L304">	} catch (IllegalArgumentException e) {</span>
<span class="fc" id="L305">	    logger.error(&quot;La personne {} {} n'apparaît pas dans la liste.&quot;, person.getFirstName(),</span>
<span class="fc" id="L306">		    person.getLastName());</span>
	}
<span class="fc" id="L308">    }</span>

    /**
     * Delete person in the JSON file
     * 
     * @param person person to delete
     * @return person deleted
     */
    public void deletePerson(Person person) {
	try {
	    // Verify if the update is done
<span class="fc" id="L319">	    boolean delete = false;</span>
	    // JSON file
<span class="fc" id="L321">	    JsonNode parsedJson = mapper.readTree(file);</span>
	    // Array to read in JSON file
<span class="fc" id="L323">	    ArrayNode personsArray = (ArrayNode) parsedJson.get(&quot;persons&quot;);</span>
<span class="fc bfc" id="L324" title="All 4 branches covered.">	    if (person.getFirstName() != null &amp;&amp; person.getLastName() != null) {</span>
		// Browse the array
<span class="fc bfc" id="L326" title="All 2 branches covered.">		for (int prsn = 0; prsn &lt; personsArray.size(); prsn++) {</span>
		    // verify If the couple of First Name and Last Name is in the list
<span class="fc bfc" id="L328" title="All 2 branches covered.">		    if (personsArray.get(prsn).get(&quot;firstName&quot;).toString().equals(&quot;\&quot;&quot; + person.getFirstName() + &quot;\&quot;&quot;)</span>
<span class="fc" id="L329">			    &amp;&amp; personsArray.get(prsn).get(&quot;lastName&quot;).toString()</span>
<span class="fc bfc" id="L330" title="All 2 branches covered.">				    .equals(&quot;\&quot;&quot; + person.getLastName() + &quot;\&quot;&quot;)) {</span>
<span class="fc" id="L331">			logger.debug(&quot;Personne à supprimer : {}&quot;, personsArray.get(prsn).toString());</span>
<span class="fc" id="L332">			personsArray.remove(prsn);</span>
<span class="fc" id="L333">			mapper.writeValue(file, parsedJson);</span>
<span class="fc" id="L334">			delete = true;</span>
		    }
		}
<span class="fc" id="L337">	    } else {</span>
<span class="fc" id="L338">		throw new IllegalArgumentException(&quot;Il faut un nom et un prénom !&quot;);</span>
	    }
<span class="fc bfc" id="L340" title="All 2 branches covered.">	    if (!delete) {</span>
<span class="fc" id="L341">		throw new NullPointerException(&quot;Aucune personne avec ce nom et prénom dans la liste !&quot;);</span>
	    }
<span class="nc" id="L343">	} catch (IOException e) {</span>
<span class="nc" id="L344">	    logger.error(&quot;Le fichier n'a pas pu être lu&quot;);</span>
<span class="fc" id="L345">	} catch (IllegalArgumentException e) {</span>
<span class="fc" id="L346">	    logger.error(&quot;La personne {} {} n'apparaît pas dans la liste.&quot;, person.getFirstName(),</span>
<span class="fc" id="L347">		    person.getLastName());</span>
<span class="fc" id="L348">	} catch (NullPointerException e) {</span>
<span class="fc" id="L349">	    logger.error(&quot;Il faut un nom et un prénom pour pouvoir supprimer un objet !&quot;);</span>
	}
<span class="fc" id="L351">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>