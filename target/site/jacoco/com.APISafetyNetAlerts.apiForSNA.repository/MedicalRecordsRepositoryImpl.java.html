<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="fr"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>MedicalRecordsRepositoryImpl.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">api</a> &gt; <a href="index.source.html" class="el_package">com.APISafetyNetAlerts.apiForSNA.repository</a> &gt; <span class="el_source">MedicalRecordsRepositoryImpl.java</span></div><h1>MedicalRecordsRepositoryImpl.java</h1><pre class="source lang-java linenums">package com.APISafetyNetAlerts.apiForSNA.repository;

import java.io.File;
import java.io.IOException;

import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
import org.springframework.stereotype.Repository;

import com.APISafetyNetAlerts.apiForSNA.model.ListMedicalRecords;
import com.APISafetyNetAlerts.apiForSNA.model.MedicalRecords;
import com.fasterxml.jackson.databind.DeserializationFeature;
import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import com.fasterxml.jackson.databind.ObjectWriter;
import com.fasterxml.jackson.databind.node.ArrayNode;
import com.fasterxml.jackson.databind.node.ObjectNode;
import com.fasterxml.jackson.databind.ser.impl.SimpleBeanPropertyFilter;
import com.fasterxml.jackson.databind.ser.impl.SimpleFilterProvider;

/**
 * 
 * Interaction with the object medicalrecords in the data.json file
 *
 */

@Repository
<span class="fc" id="L28">public class MedicalRecordsRepositoryImpl implements MedicalRecordsRepository {</span>
    // ObjectMapper to be able to deserialize JSON
<span class="fc" id="L30">    private ObjectMapper mapper = new ObjectMapper();</span>
    // List medical records to load
    private ListMedicalRecords loadListMedicalRecords;
    // List medical records to send
<span class="fc" id="L34">    private ListMedicalRecords listMedicalRecordsToSend = new ListMedicalRecords();</span>
    // Logger
<span class="fc" id="L36">    private static Logger logger = LogManager.getLogger(MedicalRecordsRepositoryImpl.class);</span>
    // Path file
<span class="fc" id="L38">    File file = new File(&quot;D:\\workspace\\git\\apiForSNA\\src\\main\\resources\\data.json&quot;);</span>

    /**
     * Read JSON file if it has not been read already and load it
     * 
     * @return a list of medical records from file
     */
    @Override
    public ListMedicalRecords loadMedicalRecords(boolean force) {
<span class="fc" id="L47">	mapper.findAndRegisterModules();</span>
<span class="fc" id="L48">	mapper.configure(DeserializationFeature.FAIL_ON_UNKNOWN_PROPERTIES, false);</span>
<span class="fc bfc" id="L49" title="All 4 branches covered.">	if (loadListMedicalRecords == null || force) {</span>
	    try {
<span class="fc" id="L51">		File file = new File(&quot;D:\\workspace\\git\\apiForSNA\\src\\main\\resources\\data.json&quot;);</span>
<span class="fc" id="L52">		loadListMedicalRecords = mapper.readValue(file, ListMedicalRecords.class);</span>
<span class="fc" id="L53">		logger.info(&quot;Le fichier est lu pour récupérer les antécédents médicaux!&quot;);</span>
<span class="fc" id="L54">		return loadListMedicalRecords;</span>
<span class="nc" id="L55">	    } catch (IOException e) {</span>
<span class="nc" id="L56">		logger.error(&quot;Fichier introuvable&quot;);</span>
	    }
	}
<span class="fc" id="L59">	return loadListMedicalRecords;</span>
    }

    /**
     * Get all the medical records
     * 
     * @return a list of all medical records
     */
    @Override
    public ListMedicalRecords findAllMedicalRecords() {
	// Read the file and fill the list if it's not
<span class="fc" id="L70">	listMedicalRecordsToSend = loadMedicalRecords(false);</span>
<span class="fc" id="L71">	return listMedicalRecordsToSend;</span>
    }

    /**
     * Add new medical record to the JSON File
     * 
     * @param medicalRecord medical record to add
     * @return created medical record
     */
    @Override
    public void saveMedicalRecord(MedicalRecords medicalRecord) {

<span class="fc" id="L83">	MedicalRecords newMedicalRecord = new MedicalRecords(medicalRecord.getFirstName(), medicalRecord.getLastName(),</span>
<span class="fc" id="L84">		medicalRecord.getBirthdate(), medicalRecord.getMedications(), medicalRecord.getAllergies());</span>
<span class="fc" id="L85">	logger.debug(&quot;Le dossier médical à ajouter : {}&quot;, medicalRecord.toString());</span>
	try {
<span class="fc bfc" id="L87" title="All 4 branches covered.">	    if (medicalRecord.getFirstName() != null &amp;&amp; medicalRecord.getLastName() != null</span>
<span class="fc bfc" id="L88" title="All 4 branches covered.">		    &amp;&amp; medicalRecord.getBirthdate() != null &amp;&amp; medicalRecord.getMedications() != null</span>
<span class="fc bfc" id="L89" title="All 2 branches covered.">		    &amp;&amp; medicalRecord.getAllergies() != null) {</span>
		// Filter rules to apply to the bean
<span class="fc" id="L91">		SimpleBeanPropertyFilter monFiltre = SimpleBeanPropertyFilter.serializeAll();</span>
		// This allow the filter to apply to all the beans with dynamic filters
<span class="fc" id="L93">		SimpleFilterProvider filtres = new SimpleFilterProvider().addFilter(&quot;filtreDynamiquePerson&quot;, monFiltre);</span>
		// set filter
<span class="fc" id="L95">		mapper.setFilterProvider(filtres);</span>
		// Log the result if debug mode is enabled

<span class="fc bfc" id="L98" title="All 2 branches covered.">		if (logger.isDebugEnabled()) {</span>
<span class="fc" id="L99">		    ObjectMapper objectMapper = new ObjectMapper();</span>
		    try {
<span class="fc" id="L101">			String json = objectMapper.setFilterProvider(filtres).writerWithDefaultPrettyPrinter()</span>
<span class="fc" id="L102">				.writeValueAsString(newMedicalRecord);</span>
<span class="fc" id="L103">			logger.debug(&quot;Personn à ajouter : {}&quot;, json);</span>
<span class="nc" id="L104">		    } catch (Exception e) {</span>
<span class="nc" id="L105">			logger.error(&quot;Mapping error&quot;);</span>
<span class="fc" id="L106">		    }</span>
		}

		// Writer to write in Json
<span class="fc" id="L110">		ObjectWriter writer = mapper.writer();</span>

		// read json file
<span class="fc" id="L113">		JsonNode parsedJson = mapper.readTree(file);</span>
		// Get the array of persons
<span class="fc" id="L115">		ArrayNode personsArray = (ArrayNode) parsedJson.get(&quot;medicalrecords&quot;);</span>
		// add person to the array
<span class="fc" id="L117">		personsArray.add(mapper.convertValue(newMedicalRecord, JsonNode.class));</span>
		// write in the file
<span class="fc" id="L119">		writer.writeValue(file, parsedJson);</span>
<span class="fc" id="L120">		loadMedicalRecords(true);</span>
<span class="fc" id="L121">	    } else {</span>
<span class="fc" id="L122">		throw new IllegalArgumentException(&quot;Un des champs est incorrect !&quot;);</span>
	    }
<span class="nc" id="L124">	} catch (IOException e) {</span>
<span class="nc" id="L125">	    logger.error(&quot;file not found&quot;);</span>
<span class="fc" id="L126">	} catch (IllegalArgumentException e) {</span>
<span class="fc bfc" id="L127" title="All 2 branches covered.">	    if (medicalRecord.getFirstName() == null)</span>
<span class="fc" id="L128">		logger.error(&quot;Le champ firstName ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L129" title="All 2 branches covered.">	    if (medicalRecord.getLastName() == null)</span>
<span class="fc" id="L130">		logger.error(&quot;Le champ lastName ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L131" title="All 2 branches covered.">	    if (medicalRecord.getBirthdate() == null)</span>
<span class="fc" id="L132">		logger.error(&quot;Le champ birthdate ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L133" title="All 2 branches covered.">	    if (medicalRecord.getMedications() == null)</span>
<span class="fc" id="L134">		logger.error(&quot;Le champ medications ne doit pas être vide !&quot;);</span>
<span class="fc bfc" id="L135" title="All 2 branches covered.">	    if (medicalRecord.getAllergies() == null)</span>
<span class="fc" id="L136">		logger.error(&quot;Le champ allergies ne doit pas être vide !&quot;);</span>
<span class="pc" id="L137">	}</span>

<span class="fc" id="L139">    }</span>

    /**
     * Update medicalrecords in the JSON File
     * 
     * @param medicalRecord medical record to update
     * @return updated medical record
     */
    @Override
    public void updateMedicalRecord(MedicalRecords medicalRecord) {
	try {
	    // Verify if the update is done
<span class="fc" id="L151">	    boolean update = false;</span>
	    // JSON file
<span class="fc" id="L153">	    JsonNode parsedJson = mapper.readTree(file);</span>
	    // Array to read in JSON file
<span class="fc" id="L155">	    ArrayNode medicalRecordsArray = (ArrayNode) parsedJson.get(&quot;medicalrecords&quot;);</span>
	    // Object to get
	    ObjectNode object;
	    // Browse the array
<span class="fc bfc" id="L159" title="All 2 branches covered.">	    for (int medciRec = 0; medciRec &lt; medicalRecordsArray.size(); medciRec++) {</span>
		// verify If the couple of First Name and Last Name is in the list
<span class="fc" id="L161">		if (medicalRecordsArray.get(medciRec).get(&quot;firstName&quot;).toString()</span>
<span class="fc bfc" id="L162" title="All 2 branches covered.">			.equals(&quot;\&quot;&quot; + medicalRecord.getFirstName() + &quot;\&quot;&quot;)</span>
<span class="fc" id="L163">			&amp;&amp; medicalRecordsArray.get(medciRec).get(&quot;lastName&quot;).toString()</span>
<span class="fc bfc" id="L164" title="All 2 branches covered.">				.equals(&quot;\&quot;&quot; + medicalRecord.getLastName() + &quot;\&quot;&quot;)) {</span>
<span class="fc" id="L165">		    object = (ObjectNode) medicalRecordsArray.get(medciRec);</span>
<span class="fc" id="L166">		    logger.debug(&quot;Dossier médical à modifier : {}&quot;, object.toString());</span>
<span class="fc bfc" id="L167" title="All 2 branches covered.">		    if (medicalRecord.getBirthdate() != null</span>
<span class="fc bfc" id="L168" title="All 2 branches covered.">			    &amp;&amp; medicalRecord.getBirthdate().matches(&quot;\\d{2}/\\d{2}/\\d{4}&quot;))</span>
<span class="fc" id="L169">			object.put(&quot;birthdate&quot;, medicalRecord.getBirthdate());</span>
<span class="fc bfc" id="L170" title="All 2 branches covered.">		    if (medicalRecord.getMedications() != null)</span>
<span class="fc" id="L171">			object.putPOJO(&quot;medications&quot;, medicalRecord.getMedications());</span>
<span class="fc bfc" id="L172" title="All 2 branches covered.">		    if (medicalRecord.getAllergies() != null)</span>
<span class="fc" id="L173">			object.putPOJO(&quot;allergies&quot;, medicalRecord.getAllergies());</span>
<span class="fc" id="L174">		    mapper.writeValue(file, parsedJson);</span>
<span class="fc" id="L175">		    logger.debug(&quot;Personne qui a été modifiée : {}&quot;, object.toString());</span>
<span class="fc" id="L176">		    update = true;</span>
		}
	    }
<span class="fc bfc" id="L179" title="All 2 branches covered.">	    if (!update) {</span>
<span class="fc" id="L180">		throw new IllegalArgumentException(&quot;Il n'y a aucune personne avec ce nom et prénom dans la liste !&quot;);</span>
	    }
<span class="nc" id="L182">	} catch (IOException e) {</span>
<span class="nc" id="L183">	    logger.error(&quot;Le fichier n'a pas pu être lu&quot;);</span>
<span class="fc" id="L184">	} catch (IllegalArgumentException e) {</span>
<span class="fc" id="L185">	    logger.error(&quot;La personne {} {} n'apparaît pas dans la liste.&quot;, medicalRecord.getFirstName(),</span>
<span class="fc" id="L186">		    medicalRecord.getLastName());</span>
<span class="pc" id="L187">	}</span>
<span class="fc" id="L188">    }</span>

    /**
     * Delete medical record in the JSON file
     * 
     * @param medicalRecord medical record to delete
     */
    @Override
    public void deleteMedicalRecord(MedicalRecords medicalRecord) {
	try {
	    // Verify if the update is done
<span class="fc" id="L199">	    boolean delete = false;</span>
	    // JSON file
<span class="fc" id="L201">	    JsonNode parsedJson = mapper.readTree(file);</span>
	    // Array to read in JSON file
<span class="fc" id="L203">	    ArrayNode medicalRecordArray = (ArrayNode) parsedJson.get(&quot;medicalrecords&quot;);</span>
<span class="fc bfc" id="L204" title="All 4 branches covered.">	    if (medicalRecord.getFirstName() != null &amp;&amp; medicalRecord.getLastName() != null) {</span>
		// Browse the array
<span class="fc bfc" id="L206" title="All 2 branches covered.">		for (int medicRec = 0; medicRec &lt; medicalRecordArray.size(); medicRec++) {</span>
		    // verify If the couple of First Name and Last Name is in the list
<span class="fc" id="L208">		    if (medicalRecordArray.get(medicRec).get(&quot;firstName&quot;).toString()</span>
<span class="fc bfc" id="L209" title="All 2 branches covered.">			    .equals(&quot;\&quot;&quot; + medicalRecord.getFirstName() + &quot;\&quot;&quot;)</span>
<span class="fc" id="L210">			    &amp;&amp; medicalRecordArray.get(medicRec).get(&quot;lastName&quot;).toString()</span>
<span class="fc bfc" id="L211" title="All 2 branches covered.">				    .equals(&quot;\&quot;&quot; + medicalRecord.getLastName() + &quot;\&quot;&quot;)) {</span>
<span class="fc" id="L212">			logger.debug(&quot;Personne à supprimer : {}&quot;, medicalRecordArray.get(medicRec).toString());</span>
<span class="fc" id="L213">			medicalRecordArray.remove(medicRec);</span>
<span class="fc" id="L214">			mapper.writeValue(file, parsedJson);</span>
<span class="fc" id="L215">			delete = true;</span>
		    }
		}
	    } else {
<span class="fc" id="L219">		throw new NullPointerException(&quot;Aucune personne avec ce nom et prénom dans la liste !&quot;);</span>
	    }
<span class="fc bfc" id="L221" title="All 2 branches covered.">	    if (!delete) {</span>
<span class="fc" id="L222">		throw new IllegalArgumentException(&quot;Il faut un nom et un prénom !&quot;);</span>
	    }
<span class="nc" id="L224">	} catch (IOException e) {</span>
<span class="nc" id="L225">	    logger.error(&quot;Le fichier n'a pas pu être lu&quot;);</span>
<span class="fc" id="L226">	} catch (IllegalArgumentException e) {</span>
<span class="fc" id="L227">	    logger.error(&quot;La personne {} {} n'apparaît pas dans la liste.&quot;, medicalRecord.getFirstName(),</span>
<span class="fc" id="L228">		    medicalRecord.getLastName());</span>
<span class="fc" id="L229">	} catch (NullPointerException e) {</span>
<span class="fc" id="L230">	    logger.error(&quot;Il faut un nom et un prénom pour pouvoir supprimer un objet !&quot;);</span>
<span class="pc" id="L231">	}</span>
<span class="fc" id="L232">    }</span>
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>